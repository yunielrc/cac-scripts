#!/usr/bin/env sh
#
# Checks vpn client connection status and restart it if don't have internet access
#
set -eu

#
# GLOBALS:
#   END_SERVER_IP
#   MIDDLE_SERVER_IP
#

if [ -f /etc/openvpn-client-sslocal-doctor.env ]; then
  set -a
  . /etc/openvpn-client-sslocal-doctor.env
  set +a
fi

readonly OVPN_SERVICE='openvpn-client-sslocal'

if ping -c 1 -W 5 "$MIDDLE_SERVER_IP" >/dev/null 2>&1; then
  if  ! ping -c 1 -W 5 "$END_SERVER_IP" >/dev/null 2>&1; then
    echo "No access to end-server, restarting ${OVPN_SERVICE}"
    rc-service "$OVPN_SERVICE" restart
  fi
else
  if rc-service "$OVPN_SERVICE" status | grep -q started; then
   echo "No access to middle-server, stopping ${OVPN_SERVICE}"
   rc-service "$OVPN_SERVICE" stop
  fi
fi
